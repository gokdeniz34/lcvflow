@page "/admin/dashboard"
@using LcvFlow.Domain.Entities
@using LcvFlow.Domain.Interfaces
@using LcvFlow.Service.Interfaces
@using Microsoft.EntityFrameworkCore
@inject IAdminService AdminService
@inject IEventRepository EventRepository
@inject IGuestRepository GuestRepository
@inject NavigationManager NavManager
@inject IJSRuntime JS

<div class="container-fluid py-4">
    @* HEADER *@
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h2 class="fw-bold text-dark mb-0">Genel Durum</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item active text-warning fw-bold">Dashboard</li>
                </ol>
            </nav>
        </div>
        <div class="col-auto d-flex gap-2">
            @if (_selectedEventId != 0 && _allowTestData)
            {
                <button class="btn btn-warning shadow-sm fw-bold px-4" @onclick="GenerateTestData">
                    âš¡ Bu Etkinlik Ä°Ã§in Veri Ãœret
                </button>
            }
            <select class="form-select shadow-sm border-2 border-warning" @onchange="OnEventChanged" style="width: 250px;">
                <option value="0">TÃ¼m Etkinlikler (Genel BakÄ±ÅŸ)</option>
                @foreach (var ev in _events)
                {
                    <option value="@ev.Id" selected="@(_selectedEventId == ev.Id)">@ev.Name</option>
                }
            </select>
        </div>
    </div>

    @* KPI KARTLARI *@
    <div class="row g-4 mb-4">
        @foreach (var stat in GetStatCards())
        {
            <div class="col-md-3">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <div class="card-body p-4 position-relative">
                        <p class="text-muted small fw-bold text-uppercase mb-2">@stat.Label</p>
                        <h2 class="fw-bold mb-0">@stat.Value</h2>
                        <div class="position-absolute end-0 bottom-0 p-3 opacity-25 display-4">@stat.Icon</div>
                    </div>
                    <div class="progress rounded-0" style="height: 4px;">
                        <div class="progress-bar @stat.BgClass" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (_selectedEventId == 0)
    {
        <div class="row g-4">
            @* PASTA GRAFÄ°ÄžÄ° *@
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100 p-4 text-center">
                    <h6 class="fw-bold mb-4 text-start"><i class="oi oi-pie-chart me-2"></i>KatÄ±lÄ±m OranÄ±</h6>
                    <div style="height: 280px; position: relative;">
                        <canvas id="doughnutChart"></canvas>
                    </div>
                </div>
            </div>

            @* SÄ°STEM Ã–ZETÄ° (GÃœNCELLENDÄ°) *@
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100 p-4">
                    <h6 class="fw-bold mb-3"><i class="oi oi-list me-2"></i>Sistem Ã–zeti</h6>
                    <div class="list-group list-group-flush mt-2">
                        <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                            <span>Toplam Etkinlik SayÄ±sÄ±</span>
                            <span class="badge bg-secondary rounded-pill">@_events.Count</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                            <span>Aktif Etkinlik SayÄ±sÄ±</span>
                            <span class="badge bg-success rounded-pill">@_events.Count(e => e.EventDate >= DateTime.Now)</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                            <span>Toplam KayÄ±tlÄ± Davetli</span>
                            <span class="badge bg-primary rounded-pill">@_totalGuestCount</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0">
                            <span>Son 24 Saatlik KayÄ±t</span>
                            <span class="badge bg-info rounded-pill">@_last24HoursCount</span>
                        </div>
                    </div>
                    <div class="mt-auto pt-3">
                        @* BUTON AKSIYONU DÃœZELTÄ°LDÄ° *@
                        <button class="btn btn-outline-warning btn-sm w-100 fw-bold" @onclick='() => NavManager.NavigateTo("/admin/events")'>
                            TÃ¼m Etkinlikleri YÃ¶net
                        </button>
                    </div>
                </div>
            </div>

            @* BAR CHART *@
            <div class="col-12">
                <div class="card border-0 shadow-sm p-4">
                    <h6 class="fw-bold mb-4"><i class="oi oi-bar-chart me-2"></i>En YoÄŸun 10 Etkinlik</h6>
                    <div style="height: 350px; position: relative;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        @* ETKÄ°NLÄ°K DETAY TABLOSU *@
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold text-primary">Son KayÄ±tlar</h5>
                <button class="btn btn-sm btn-outline-warning fw-bold" @onclick='() => NavManager.NavigateTo($"/admin/events/{_selectedEventId}/guests")'>
                    TÃ¼mÃ¼nÃ¼ YÃ¶net
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Ad Soyad</th>
                                <th>Telefon</th>
                                <th>Durum</th>
                                <th class="text-end pe-4">Aksiyon</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_recentGuests.Any())
                            {
                                @foreach (var guest in _recentGuests)
                                {
                                    <tr>
                                        <td class="ps-4 fw-medium">@guest.FirstName @guest.LastName</td>
                                        <td>@guest.PhoneNumber</td>
                                        <td>
                                            <span class="badge @GetBadgeClass(guest.IsAttending)">
                                                @GetStatusText(guest.IsAttending)
                                            </span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <button class="btn btn-sm btn-light border" @onclick='() => NavManager.NavigateTo($"/admin/guestedit/{guest.Id}")'>Detay</button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="4" class="text-center py-4 text-muted">HenÃ¼z kayÄ±t bulunamadÄ±.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<Event> _events = new();
    private List<Guest> _recentGuests = new();
    private DashboardStats _stats = new();
    private int _selectedEventId = 0;
    private bool _allowTestData = true;
    private int _totalGuestCount = 0;
    private int _last24HoursCount = 0;

    protected override async Task OnInitializedAsync()
    {
        try {
            _events = await EventRepository.Query().ToListAsync();
            await LoadStats();
        } catch (Exception ex) {
            Console.WriteLine($"Hata: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Grafiklerin Ã§izilmesi iÃ§in JS'i tetikle (Sadece SeÃ§im '0' ise)
        if (_selectedEventId == 0 && _events.Any())
        {
            await Task.Delay(300); // DOM ve CSS'in oturmasÄ± iÃ§in biraz daha sÃ¼re tanÄ±yalÄ±m
            await RenderCharts();
        }
    }

    private async Task RenderCharts()
    {
        try {
            var allGuests = await GuestRepository.Query().ToListAsync();
            
            var doughnutData = new int[] { 
                allGuests.Count(g => g.IsAttending == true), 
                allGuests.Count(g => g.IsAttending == false), 
                allGuests.Count(g => g.IsAttending == null) 
            };

            var topEvents = _events
                .Select(e => new { e.Name, Count = allGuests.Count(g => g.EventId == e.Id) })
                .OrderByDescending(x => x.Count)
                .Take(10).ToList();

            var barData = new {
                labels = topEvents.Select(x => x.Name).ToArray(),
                counts = topEvents.Select(x => x.Count).ToArray()
            };

            await JS.InvokeVoidAsync("setupCharts", doughnutData, barData);
        } catch { /* JS henÃ¼z hazÄ±r deÄŸilse hata bastÄ±rmasÄ±n */ }
    }

    private async Task LoadStats()
    {
        IQueryable<Guest> query = GuestRepository.Query();
        
        // Genel veriler iÃ§in tÃ¼m misafirleri say
        var allGuests = await query.ToListAsync();
        _totalGuestCount = allGuests.Count;
        _last24HoursCount = allGuests.Count(g => g.CreatedAt >= DateTime.Now.AddDays(-1));

        // FiltrelenmiÅŸ veriler
        if (_selectedEventId != 0)
        {
            var filtered = allGuests.Where(g => g.EventId == _selectedEventId).ToList();
            _recentGuests = filtered.OrderByDescending(g => g.CreatedAt).Take(10).ToList();
            _stats = new DashboardStats {
                Total = filtered.Count,
                Attending = filtered.Count(g => g.IsAttending == true),
                Declined = filtered.Count(g => g.IsAttending == false),
                Pending = filtered.Count(g => g.IsAttending == null)
            };
        }
        else
        {
            _stats = new DashboardStats {
                Total = _totalGuestCount,
                Attending = allGuests.Count(g => g.IsAttending == true),
                Declined = allGuests.Count(g => g.IsAttending == false),
                Pending = allGuests.Count(g => g.IsAttending == null)
            };
        }
        StateHasChanged();
    }

    private async Task OnEventChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id)) {
            _selectedEventId = id;
            await LoadStats();
        }
    }

    private List<StatCard> GetStatCards() => new() {
        new("Toplam Davetli", _stats.Total.ToString(), "ðŸ‘¥", "bg-primary"),
        new("Gelenler", _stats.Attending.ToString(), "âœ…", "bg-success"),
        new("Gelmeyenler", _stats.Declined.ToString(), "âŒ", "bg-danger"),
        new("Bekleyenler", _stats.Pending.ToString(), "â³", "bg-warning")
    };

    private string GetBadgeClass(bool? attending) => attending switch {
        true => "bg-success-subtle text-success",
        false => "bg-danger-subtle text-danger",
        _ => "bg-warning-subtle text-warning"
    };

    private string GetStatusText(bool? attending) => attending switch {
        true => "Geliyor",
        false => "Gelmiyor",
        _ => "Bekleniyor"
    };

    private async Task GenerateTestData()
    {
        if (_selectedEventId > 0) {
            await AdminService.SeedDummyDataAsync(_selectedEventId);
            await LoadStats();
        }
    }

    public record StatCard(string Label, string Value, string Icon, string BgClass);
    public class DashboardStats { public int Total, Attending, Declined, Pending; }
}